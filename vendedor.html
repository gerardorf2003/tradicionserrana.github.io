<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Vendedor | Tradición Serrana</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .auth-card { max-width: 400px; margin: 80px auto; border-radius: 15px; }
        .upload-card { max-width: 600px; margin: 40px auto; border-radius: 15px; }
        .btn-verde { background: #2d5a27; color: white; }
        .btn-verde:hover { background: #1e3d1a; color: white; }
    </style>
</head>
<body class="bg-light">

<div class="container">
    <div id="auth-box" class="card auth-card shadow p-4">
        <h3 class="text-center mb-4">Acceso Comerciantes</h3>
        <input type="email" id="email" class="form-control mb-2" placeholder="Correo">
        <input type="password" id="pass" class="form-control mb-3" placeholder="Contraseña">
        <button id="btn-login" class="btn btn-verde w-100 mb-2">Iniciar Sesión</button>
        <button id="btn-registro" class="btn btn-outline-secondary w-100">Registrarme</button>
    </div>

    <div id="upload-box" class="card upload-card shadow p-4 d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Nuevo Producto</h4>
            <button id="btn-logout" class="btn btn-sm btn-danger">Cerrar Sesión</button>
        </div>

        <form id="form-producto">
            <div class="mb-3">
                <input type="text" id="p-nombre" class="form-control" placeholder="Nombre del producto" required>
            </div>

            <div class="mb-3">
                <input type="text" id="p-ubicacion" class="form-control" placeholder="Ubicación (ej. Municipio)" required>
            </div>

            <div class="mb-3">
                <textarea id="p-desc" class="form-control" placeholder="Descripción breve" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label small">Número de WhatsApp</label>
                <div class="input-group">
                    <span class="input-group-text">+52</span>
                    <input 
                        type="tel" 
                        id="p-telefono" 
                        class="form-control" 
                        placeholder="10 dígitos" 
                        pattern="[0-9]{10}" 
                        maxlength="10"
                        required>
                </div>
                <div class="form-text">Escribe solo los 10 dígitos sin el +52.</div>
            </div>

            <div class="mb-3">
                <label class="form-label small">Foto del producto</label>
                <input type="file" id="p-img" class="form-control" accept="image/*" required>
            </div>

            <button type="submit" id="btn-subir" class="btn btn-verde w-100">
                Publicar en Catálogo
            </button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
            apiKey: "AIzaSyDTeO88X2kS5Y35VifPK-Xp9aojdHwCEqc",
  authDomain: "tradicion-serrana-9eddb.firebaseapp.com",
  projectId: "tradicion-serrana-9eddb",
  storageBucket: "tradicion-serrana-9eddb.firebasestorage.app",
  messagingSenderId: "1029895692370",
  appId: "1:1029895692370:web:eaa51b96aeebc030ff3f8b",
  measurementId: "G-0ZKWW4YNX0"
    };

const CLOUD_NAME = "dk4fn5bun";
const UPLOAD_PRESET = "tradicion_preset";
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, user => {
        document.getElementById('auth-box').classList.toggle('d-none', user);
        document.getElementById('upload-box').classList.toggle('d-none', !user);
    });

    document.getElementById('btn-registro').onclick = () => {
        createUserWithEmailAndPassword(auth, email.value, pass.value)
            .catch(e => alert("Error: " + e.message));
    };

    document.getElementById('btn-login').onclick = () => {
        signInWithEmailAndPassword(auth, email.value, pass.value)
            .catch(e => alert("Error: " + e.message));
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth);

    document.getElementById('form-producto').onsubmit = async (e) => {
        e.preventDefault();

        const file = document.getElementById('p-img').files[0];
        const telefonoInput = document.getElementById('p-telefono').value.trim();

        if (telefonoInput.length !== 10) {
            alert("El número debe tener 10 dígitos.");
            return;
        }

        const telefonoCompleto = "52" + telefonoInput;

        const btnSubir = document.getElementById('btn-subir');
        btnSubir.disabled = true;
        btnSubir.innerText = "Subiendo...";

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);

        try {
            const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });

            const cloudData = await cloudRes.json();

            await addDoc(collection(db, "productos"), {
                nombre: document.getElementById('p-nombre').value,
                ubicacion: document.getElementById('p-ubicacion').value,
                descripcion: document.getElementById('p-desc').value,
                imagenUrl: cloudData.secure_url,
                telefono: telefonoCompleto,
                vendedorEmail: auth.currentUser.email,
                createdAt: new Date()
            });

            alert("¡Producto publicado!");
            e.target.reset();

        } catch (error) {
            alert("Error al subir el producto.");
        }

        btnSubir.disabled = false;
        btnSubir.innerText = "Publicar en Catálogo";
    };
</script>
</body>
</html>
